<<<<<<< HEAD
import type {Contract} from './contract';
import NativeModule from './NativeRNPermissions';
=======
import {NativeModules} from 'react-native';
import type {Contract} from './contract';
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
import {RESULTS} from './results';
import type {
  LocationAccuracy,
  LocationAccuracyOptions,
  NotificationOption,
  NotificationsResponse,
  Permission,
  PermissionStatus,
} from './types';
import {uniq} from './utils';

<<<<<<< HEAD
let available: string[] | undefined = undefined;

function getAvailable(): string[] {
  if (available == null) {
    available = NativeModule.getConstants().available;
  }

  return available;
}

async function openPhotoPicker(): Promise<void> {
  await NativeModule.openPhotoPicker();
=======
const NativeModule: {
  available: Permission[];

  check: (permission: Permission) => Promise<PermissionStatus>;
  checkLocationAccuracy: () => Promise<LocationAccuracy>;
  checkNotifications: () => Promise<NotificationsResponse>;
  openLimitedPhotoLibraryPicker: () => Promise<true>;
  openSettings: () => Promise<true>;
  request: (permission: Permission, options?: object) => Promise<PermissionStatus>;
  requestLocationAccuracy: (purposeKey: string) => Promise<LocationAccuracy>;
  requestNotifications: (options: NotificationOption[]) => Promise<NotificationsResponse>;
} = NativeModules.RNPermissions;

async function openLimitedPhotoLibraryPicker(): Promise<void> {
  await NativeModule.openLimitedPhotoLibraryPicker();
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
}

async function openSettings(): Promise<void> {
  await NativeModule.openSettings();
}

async function check(permission: Permission): Promise<PermissionStatus> {
<<<<<<< HEAD
  return getAvailable().includes(permission)
    ? (NativeModule.check(permission) as Promise<PermissionStatus>)
=======
  return NativeModule.available.includes(permission)
    ? NativeModule.check(permission)
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
    : RESULTS.UNAVAILABLE;
}

async function request(permission: Permission): Promise<PermissionStatus> {
<<<<<<< HEAD
  return getAvailable().includes(permission)
    ? (NativeModule.request(permission) as Promise<PermissionStatus>)
=======
  return NativeModule.available.includes(permission)
    ? NativeModule.request(permission)
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
    : RESULTS.UNAVAILABLE;
}

function checkLocationAccuracy(): Promise<LocationAccuracy> {
<<<<<<< HEAD
  return NativeModule.checkLocationAccuracy() as Promise<LocationAccuracy>;
}

function requestLocationAccuracy(options: LocationAccuracyOptions): Promise<LocationAccuracy> {
  return NativeModule.requestLocationAccuracy(options.purposeKey) as Promise<LocationAccuracy>;
}

export function checkNotifications(): Promise<NotificationsResponse> {
  return NativeModule.checkNotifications() as Promise<NotificationsResponse>;
=======
  return NativeModule.checkLocationAccuracy();
}

function requestLocationAccuracy(options: LocationAccuracyOptions): Promise<LocationAccuracy> {
  return NativeModule.requestLocationAccuracy(options.purposeKey);
}

export function checkNotifications(): Promise<NotificationsResponse> {
  return NativeModule.checkNotifications();
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
}

export function requestNotifications(
  options: NotificationOption[],
): Promise<NotificationsResponse> {
<<<<<<< HEAD
  return NativeModule.requestNotifications(options) as Promise<NotificationsResponse>;
=======
  return NativeModule.requestNotifications(options);
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
}

async function checkMultiple<P extends Permission[]>(
  permissions: P,
): Promise<Record<P[number], PermissionStatus>> {
  type Output = Record<P[number], PermissionStatus>;

  const output: Partial<Output> = {};
  const dedup = uniq(permissions);

  await Promise.all(
    dedup.map(async (permission: P[number]) => {
      output[permission] = await check(permission);
    }),
  );

  return output as Output;
}

async function requestMultiple<P extends Permission[]>(
  permissions: P,
): Promise<Record<P[number], PermissionStatus>> {
  type Output = Record<P[number], PermissionStatus>;

  const output: Partial<Output> = {};
  const dedup = uniq(permissions);

  for (let index = 0; index < dedup.length; index++) {
<<<<<<< HEAD
    const permission = dedup[index] as P[number];
=======
    const permission: P[number] = dedup[index];
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
    output[permission] = await request(permission);
  }

  return output as Output;
}

export const methods: Contract = {
  check,
  checkLocationAccuracy,
  checkMultiple,
  checkNotifications,
<<<<<<< HEAD
  openPhotoPicker,
=======
  openLimitedPhotoLibraryPicker,
>>>>>>> aec85746435d3ba41358c5b7d65f93f87448e5b8
  openSettings,
  request,
  requestLocationAccuracy,
  requestMultiple,
  requestNotifications,
};
